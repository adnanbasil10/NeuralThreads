// eslint-disable-next-line @typescript-eslint/ban-ts-comment
// @ts-ignore - clamdjs ships without TypeScript declarations
import clamd from 'clamdjs';

let scanner: ReturnType<typeof clamd.createScanner> | null = null;

function getScanner() {
  const host = process.env.CLAMAV_HOST;
  const port = process.env.CLAMAV_PORT ? parseInt(process.env.CLAMAV_PORT, 10) : 3310;

  if (!host || Number.isNaN(port)) {
    return null;
  }

  if (!scanner) {
    try {
      scanner = clamd.createScanner(host, port);
    } catch (error) {
      console.warn('Unable to initialize ClamAV scanner:', error);
      scanner = null;
    }
  }

  return scanner;
}

export async function scanBufferForMalware(buffer: Buffer): Promise<void> {
  const clamScanner = getScanner();
  if (!clamScanner) return;

  try {
    const reply = await clamScanner.scanBuffer(buffer);
    if (!clamd.isCleanReply(reply.toString())) {
      throw new Error('Malware detected in uploaded file');
    }
  } catch (error) {
    console.error('Malware scanning failed:', error);
    throw new Error('File failed malware scanning');
  }
}










